{
  "schemaVersion": 3,
  "featureId": "feat-upload",
  "featureName": "Audio Upload",
  "prefix": "upload",
  "summary": "Upload audio files for processing with validation and progress feedback",
  "generatedAt": "2026-01-16T00:00:00.000Z",
  "dependencies": [],
  "stack": {
    "platform": "web",
    "frontend": "next.js",
    "backend": "node.js",
    "database": "sqlite"
  },
  "packages": [
    {
      "name": "multer",
      "reason": "Multipart file upload handling for audio files in Node.js"
    },
    {
      "name": "uuid",
      "reason": "Generate unique job IDs"
    },
    {
      "name": "zod",
      "reason": "Schema validation for upload metadata"
    },
    {
      "name": "better-sqlite3",
      "reason": "Synchronous SQLite driver for job storage"
    },
    {
      "name": "drizzle-orm",
      "reason": "Type-safe ORM for SQLite"
    },
    {
      "name": "lucide-react",
      "reason": "Icons for upload UI"
    }
  ],
  "dataSchema": {
    "tables": [
      {
        "name": "jobs",
        "description": "Tracks entire job lifecycle from upload to completion",
        "columns": [
          { "name": "id", "type": "TEXT", "constraints": "PRIMARY KEY", "description": "UUID for the job" },
          { "name": "status", "type": "TEXT", "constraints": "NOT NULL DEFAULT 'UPLOADED'", "description": "Job state: UPLOADED, ISOLATING, TRANSCRIBING, NOTATING, DONE, FAILED" },
          { "name": "progress", "type": "INTEGER", "constraints": "NOT NULL DEFAULT 0", "description": "Progress percentage 0-100" },
          { "name": "input_file_path", "type": "TEXT", "constraints": "NOT NULL", "description": "Local path to uploaded audio file" },
          { "name": "input_file_name", "type": "TEXT", "constraints": "NOT NULL", "description": "Original filename from user" },
          { "name": "input_file_size", "type": "INTEGER", "constraints": "NOT NULL", "description": "File size in bytes" },
          { "name": "input_file_format", "type": "TEXT", "constraints": "NOT NULL", "description": "File format: mp3, wav, flac, ogg" },
          { "name": "input_duration_seconds", "type": "REAL", "constraints": "", "description": "Audio duration in seconds (populated after validation)" },
          { "name": "isolated_piano_path", "type": "TEXT", "constraints": "", "description": "Local path to isolated piano audio" },
          { "name": "midi_path", "type": "TEXT", "constraints": "", "description": "Local path to generated MIDI file" },
          { "name": "musicxml_path", "type": "TEXT", "constraints": "", "description": "Local path to generated MusicXML file" },
          { "name": "pdf_path", "type": "TEXT", "constraints": "", "description": "Local path to generated PDF file" },
          { "name": "settings_json", "type": "TEXT", "constraints": "", "description": "JSON string of readability settings" },
          { "name": "error_code", "type": "TEXT", "constraints": "", "description": "Error code if job failed" },
          { "name": "error_message", "type": "TEXT", "constraints": "", "description": "Human-readable error message" },
          { "name": "created_at", "type": "TEXT", "constraints": "NOT NULL DEFAULT (datetime('now'))", "description": "ISO timestamp of job creation" },
          { "name": "updated_at", "type": "TEXT", "constraints": "NOT NULL DEFAULT (datetime('now'))", "description": "ISO timestamp of last update" }
        ],
        "indexes": [
          { "name": "idx_jobs_status", "columns": ["status"] },
          { "name": "idx_jobs_created_at", "columns": ["created_at"] }
        ]
      }
    ]
  },
  "apiEndpoints": [
    {
      "method": "POST",
      "path": "/api/upload",
      "description": "Upload an audio file and create a new job",
      "requestBody": {
        "type": "multipart/form-data",
        "fields": [
          { "name": "file", "type": "File", "required": true, "description": "Audio file (mp3, wav, flac, ogg)" }
        ]
      },
      "responses": [
        {
          "status": 201,
          "description": "Job created successfully",
          "body": {
            "jobId": "string (UUID)",
            "status": "UPLOADED",
            "fileName": "string",
            "fileSize": "number (bytes)",
            "format": "string"
          }
        },
        {
          "status": 400,
          "description": "Validation error",
          "body": {
            "error": "string",
            "code": "INVALID_FORMAT | FILE_TOO_LARGE | FILE_EMPTY | DURATION_TOO_SHORT"
          }
        },
        {
          "status": 500,
          "description": "Server error",
          "body": {
            "error": "string",
            "code": "UPLOAD_FAILED"
          }
        }
      ],
      "validations": [
        "File format must be mp3, wav, flac, or ogg",
        "File size must be <= 500MB",
        "File must not be empty"
      ]
    },
    {
      "method": "GET",
      "path": "/api/jobs/[jobId]",
      "description": "Get job status and details",
      "parameters": [
        { "name": "jobId", "in": "path", "type": "string", "required": true, "description": "UUID of the job" }
      ],
      "responses": [
        {
          "status": 200,
          "description": "Job found",
          "body": {
            "id": "string",
            "status": "string",
            "progress": "number",
            "fileName": "string",
            "fileSize": "number",
            "format": "string",
            "durationSeconds": "number | null",
            "errorCode": "string | null",
            "errorMessage": "string | null",
            "createdAt": "string (ISO)",
            "updatedAt": "string (ISO)"
          }
        },
        {
          "status": 404,
          "description": "Job not found",
          "body": {
            "error": "Job not found",
            "code": "JOB_NOT_FOUND"
          }
        }
      ]
    }
  ],
  "pages": [
    {
      "path": "/",
      "name": "Home / Upload Page",
      "description": "Main landing page with upload zone and recent jobs list",
      "components": [
        {
          "name": "UploadZone",
          "description": "Drag-and-drop area for audio file upload",
          "props": [
            { "name": "onUploadStart", "type": "(file: File) => void", "description": "Called when upload begins" },
            { "name": "onUploadProgress", "type": "(progress: number) => void", "description": "Called with upload progress 0-100" },
            { "name": "onUploadComplete", "type": "(job: Job) => void", "description": "Called when upload succeeds" },
            { "name": "onUploadError", "type": "(error: UploadError) => void", "description": "Called when upload fails" },
            { "name": "disabled", "type": "boolean", "description": "Disable upload during active upload" }
          ],
          "states": [
            { "name": "idle", "description": "Default state, showing upload prompt" },
            { "name": "dragOver", "description": "File is being dragged over the zone" },
            { "name": "uploading", "description": "File is being uploaded, show progress" },
            { "name": "success", "description": "Upload complete, show file info" },
            { "name": "error", "description": "Upload failed, show error message" }
          ],
          "uiNotes": [
            "Large rectangular zone with 4px dashed black border",
            "Upload icon (Lucide Upload) centered, 48px",
            "Uppercase text: 'DROP AUDIO FILE OR CLICK TO UPLOAD'",
            "Supported formats listed: 'MP3, WAV, FLAC, OGG â€¢ MAX 500MB'",
            "On dragOver: border becomes solid, background #F2F2F2",
            "On uploading: progress bar appears (black fill, white track)",
            "On success: checkmark icon, file name displayed",
            "On error: error icon (Lucide AlertCircle), error message in Swiss Red"
          ]
        },
        {
          "name": "FileInfoCard",
          "description": "Displays uploaded file information before processing",
          "props": [
            { "name": "fileName", "type": "string", "description": "Original file name" },
            { "name": "fileSize", "type": "number", "description": "Size in bytes" },
            { "name": "format", "type": "string", "description": "File format" },
            { "name": "duration", "type": "number | null", "description": "Duration in seconds" },
            { "name": "onStartProcessing", "type": "() => void", "description": "Start the processing pipeline" },
            { "name": "onCancel", "type": "() => void", "description": "Cancel and reset" }
          ],
          "uiNotes": [
            "Card with 2px black border",
            "File icon (Lucide FileAudio) + file name in bold",
            "Format badge (uppercase, black background, white text)",
            "Size formatted (e.g., '12.4 MB')",
            "Duration if available (e.g., '3:24')",
            "'START PROCESSING' button (Swiss Red background, white text, full width)",
            "'CANCEL' link below button (black text, underline on hover)"
          ]
        },
        {
          "name": "UploadProgress",
          "description": "Progress bar for file upload",
          "props": [
            { "name": "progress", "type": "number", "description": "Progress 0-100" },
            { "name": "fileName", "type": "string", "description": "Name of file being uploaded" }
          ],
          "uiNotes": [
            "Full-width progress bar",
            "Track: white with 2px black border",
            "Fill: black, width based on progress percentage",
            "File name above progress bar (truncate with ellipsis if long)",
            "Percentage displayed to right of bar"
          ]
        }
      ],
      "layout": [
        "Header with app title 'PIANO SHEET GENERATOR' (text-4xl, uppercase, font-black)",
        "Subheadline: 'TURN ANY SONG INTO PIANO SHEET MUSIC' (text-xl, uppercase)",
        "Upload zone centered, max-width 600px",
        "After upload: FileInfoCard replaces upload zone",
        "Recent jobs list below (handled by feat-job-history)"
      ]
    },
    {
      "path": "/job/[jobId]",
      "name": "Job Status Page",
      "description": "Shows processing progress or results for a specific job",
      "components": [
        {
          "name": "JobStatusHeader",
          "description": "Shows job file info and current status",
          "props": [
            { "name": "job", "type": "Job", "description": "Full job object" }
          ],
          "uiNotes": [
            "File name as page title (text-2xl, uppercase, font-bold)",
            "Format badge + duration + file size on second line",
            "Status badge showing current state"
          ]
        }
      ],
      "layout": [
        "JobStatusHeader at top",
        "Processing stepper (handled by feat-isolation)",
        "Results section when DONE (handled by feat-preview)"
      ]
    }
  ],
  "userFlows": [
    {
      "id": "flow-drag-upload",
      "name": "Drag and Drop Upload",
      "description": "User uploads audio file via drag and drop",
      "steps": [
        { "step": 1, "action": "User drags audio file over upload zone", "result": "Zone highlights with solid border and gray background" },
        { "step": 2, "action": "User drops file", "result": "File validation begins (format, size check)" },
        { "step": 3, "action": "Validation passes", "result": "Upload progress bar appears, file uploads to server" },
        { "step": 4, "action": "Upload completes", "result": "FileInfoCard appears with file details and 'START PROCESSING' button" },
        { "step": 5, "action": "Server creates job record", "result": "Job in UPLOADED state, returns jobId" },
        { "step": 6, "action": "User clicks 'START PROCESSING'", "result": "Navigates to /job/[jobId], processing begins" }
      ]
    },
    {
      "id": "flow-click-upload",
      "name": "Click to Upload",
      "description": "User uploads audio file via file picker",
      "steps": [
        { "step": 1, "action": "User clicks upload zone", "result": "Native file picker opens" },
        { "step": 2, "action": "User selects audio file", "result": "File validation begins" },
        { "step": 3, "action": "Same as drag-drop flow from step 3", "result": "Same flow continues" }
      ]
    },
    {
      "id": "flow-invalid-format",
      "name": "Invalid File Format",
      "description": "User uploads unsupported file type",
      "steps": [
        { "step": 1, "action": "User drops/selects non-audio file (e.g., .pdf)", "result": "Client-side validation catches invalid format" },
        { "step": 2, "action": "Error displayed", "result": "Upload zone shows error: 'UNSUPPORTED FORMAT. USE MP3, WAV, FLAC, OR OGG.'" },
        { "step": 3, "action": "User can retry", "result": "Zone resets to idle state after 3 seconds or on click" }
      ]
    },
    {
      "id": "flow-file-too-large",
      "name": "File Too Large",
      "description": "User uploads file exceeding 500MB limit",
      "steps": [
        { "step": 1, "action": "User drops/selects file > 500MB", "result": "Client-side validation catches size limit" },
        { "step": 2, "action": "Error displayed", "result": "Upload zone shows error: 'FILE TOO LARGE. MAXIMUM 500MB.'" },
        { "step": 3, "action": "User can retry", "result": "Zone resets to idle state" }
      ]
    },
    {
      "id": "flow-upload-network-error",
      "name": "Upload Network Error",
      "description": "Upload fails due to network issue",
      "steps": [
        { "step": 1, "action": "File upload starts", "result": "Progress bar shows" },
        { "step": 2, "action": "Network error occurs mid-upload", "result": "Upload aborts" },
        { "step": 3, "action": "Error displayed", "result": "Upload zone shows: 'UPLOAD FAILED. TRY AGAIN.' with retry button" },
        { "step": 4, "action": "User clicks retry", "result": "Upload restarts from beginning" }
      ]
    }
  ],
  "errorStates": [
    {
      "code": "INVALID_FORMAT",
      "message": "UNSUPPORTED FORMAT. USE MP3, WAV, FLAC, OR OGG.",
      "trigger": "File extension or MIME type not in allowed list",
      "recovery": "User selects different file"
    },
    {
      "code": "FILE_TOO_LARGE",
      "message": "FILE TOO LARGE. MAXIMUM 500MB.",
      "trigger": "File size exceeds 500MB (524,288,000 bytes)",
      "recovery": "User selects smaller file or compresses audio"
    },
    {
      "code": "FILE_EMPTY",
      "message": "FILE IS EMPTY.",
      "trigger": "File size is 0 bytes",
      "recovery": "User selects valid file"
    },
    {
      "code": "UPLOAD_FAILED",
      "message": "UPLOAD FAILED. TRY AGAIN.",
      "trigger": "Network error, server error, or timeout during upload",
      "recovery": "User retries upload"
    },
    {
      "code": "DURATION_TOO_SHORT",
      "message": "AUDIO TOO SHORT. MINIMUM 5 SECONDS.",
      "trigger": "Audio duration less than 5 seconds (fal.ai requirement)",
      "recovery": "User selects longer audio file"
    }
  ],
  "validations": [
    {
      "field": "file",
      "rules": [
        { "rule": "required", "message": "Please select a file to upload" },
        { "rule": "format", "allowed": ["mp3", "wav", "flac", "ogg"], "message": "Unsupported format. Use MP3, WAV, FLAC, or OGG." },
        { "rule": "maxSize", "bytes": 524288000, "message": "File too large. Maximum 500MB." },
        { "rule": "minSize", "bytes": 1, "message": "File is empty." }
      ]
    }
  ],
  "fileStorage": {
    "uploadDirectory": "./uploads",
    "namingConvention": "{jobId}/{original_filename}",
    "cleanup": "Files remain until job is deleted",
    "notes": "Create uploads directory if not exists. Store files organized by jobId for easy cleanup."
  },
  "implementationNotes": [
    "Use multer with disk storage for file uploads",
    "Validate file format by both extension and MIME type",
    "Client-side validation before upload to avoid unnecessary network usage",
    "Show upload progress using XMLHttpRequest or fetch with ReadableStream",
    "Create job record in SQLite immediately after successful upload",
    "Generate UUID v4 for job IDs",
    "File input should accept only audio formats: accept='audio/mpeg,audio/wav,audio/flac,audio/ogg'",
    "Handle drag events: dragenter, dragover, dragleave, drop",
    "Prevent default behavior on drag events to enable custom drop zone",
    "Use Next.js API routes for /api/upload endpoint"
  ],
  "acceptanceCriteria": [
    "User can drag and drop audio file onto upload zone",
    "User can click upload zone to open file picker",
    "Upload zone shows visual feedback on drag over",
    "Progress bar shows during upload",
    "Invalid files show appropriate error messages",
    "Successful upload shows file info card with details",
    "Job is created in database with UPLOADED status",
    "File is stored in uploads directory",
    "User can click 'START PROCESSING' to begin pipeline",
    "All UI follows Swiss design system (thick borders, no rounded corners, uppercase text)"
  ]
}
