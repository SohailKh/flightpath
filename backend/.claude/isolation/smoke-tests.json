{
  "schemaVersion": 1,
  "featureId": "feat-isolation",
  "featureName": "Piano Isolation",
  "generatedAt": "2026-01-16T00:00:00.000Z",
  "testSuites": [
    {
      "name": "IsolationService Unit Tests",
      "type": "unit",
      "path": "src/services/__tests__/isolation.test.ts",
      "tests": [
        {
          "id": "ISO-UT-001",
          "name": "uploadToFalStorage uploads file and returns URL",
          "requirementId": "ISO-003",
          "description": "Verify that local audio files are uploaded to fal.ai storage correctly",
          "setup": "Mock fal.storage.upload to return a URL",
          "steps": [
            "Create a mock audio file buffer",
            "Call uploadToFalStorage with file path",
            "Verify fal.storage.upload was called with correct parameters",
            "Verify returned URL matches mock response"
          ],
          "expectedResult": "Returns fal.ai storage URL for the uploaded file",
          "mocks": ["fal.storage.upload"]
        },
        {
          "id": "ISO-UT-002",
          "name": "isolatePiano calls SAM Audio API with correct parameters",
          "requirementId": "ISO-002",
          "description": "Verify correct API call structure to fal.ai SAM Audio",
          "setup": "Mock fal.subscribe to return success response",
          "steps": [
            "Call isolatePiano with a fal.ai audio URL",
            "Verify fal.subscribe was called with 'fal-ai/sam-audio/separate'",
            "Verify input.audio_url matches provided URL",
            "Verify input.prompt is 'piano playing'",
            "Verify input.output_format is 'wav'"
          ],
          "expectedResult": "API called with correct model ID and input parameters",
          "mocks": ["fal.subscribe"]
        },
        {
          "id": "ISO-UT-003",
          "name": "isolatePiano tracks progress via onQueueUpdate",
          "requirementId": "ISO-004",
          "description": "Verify progress callbacks are received and processed",
          "setup": "Mock fal.subscribe with onQueueUpdate callback simulation",
          "steps": [
            "Call isolatePiano with progress callback",
            "Simulate queue status updates (IN_QUEUE, IN_PROGRESS)",
            "Verify progress callback is invoked with correct values",
            "Verify progress increases monotonically"
          ],
          "expectedResult": "Progress callback receives updates during processing",
          "mocks": ["fal.subscribe"]
        },
        {
          "id": "ISO-UT-004",
          "name": "downloadIsolatedAudio saves file to correct path",
          "requirementId": "ISO-005",
          "description": "Verify isolated audio is downloaded and saved locally",
          "setup": "Mock fetch to return audio data, mock fs.writeFile",
          "steps": [
            "Call downloadIsolatedAudio with target URL and job ID",
            "Verify fetch was called with target URL",
            "Verify file written to uploads/{jobId}/isolated_piano.wav",
            "Verify function returns correct local path"
          ],
          "expectedResult": "Audio file saved to local storage with correct path",
          "mocks": ["fetch", "fs.writeFile"]
        },
        {
          "id": "ISO-UT-005",
          "name": "handleError categorizes API errors correctly",
          "requirementId": "ISO-007",
          "description": "Verify errors are mapped to correct error codes",
          "setup": "Create mock error objects for each error type",
          "steps": [
            "Call handleError with rate limit error",
            "Verify returns ISOLATION_RATE_LIMIT code",
            "Call handleError with timeout error",
            "Verify returns ISOLATION_TIMEOUT code",
            "Call handleError with invalid audio error",
            "Verify returns ISOLATION_INVALID_AUDIO code"
          ],
          "expectedResult": "Each error type maps to correct error code and message",
          "mocks": []
        },
        {
          "id": "ISO-UT-006",
          "name": "retry logic uses exponential backoff",
          "requirementId": "ISO-008",
          "description": "Verify retry timing follows exponential backoff pattern",
          "setup": "Mock fal.subscribe to fail, mock setTimeout",
          "steps": [
            "Call isolatePiano which fails",
            "Verify first retry after 1 second",
            "Verify second retry after 2 seconds",
            "Verify third retry after 4 seconds",
            "Verify no retry after third failure"
          ],
          "expectedResult": "Retries use 1s, 2s, 4s delays then fail",
          "mocks": ["fal.subscribe", "setTimeout"]
        },
        {
          "id": "ISO-UT-007",
          "name": "does not retry on permanent errors",
          "requirementId": "ISO-008",
          "description": "Verify certain errors bypass retry logic",
          "setup": "Mock fal.subscribe to return authentication error",
          "steps": [
            "Call isolatePiano which returns auth error",
            "Verify fal.subscribe only called once",
            "Verify error returned immediately",
            "Repeat for invalid audio error"
          ],
          "expectedResult": "Permanent errors fail immediately without retry",
          "mocks": ["fal.subscribe"]
        }
      ]
    },
    {
      "name": "Isolation API Endpoint Tests",
      "type": "integration",
      "path": "src/app/api/jobs/__tests__/isolation-api.test.ts",
      "tests": [
        {
          "id": "ISO-IT-001",
          "name": "GET /api/jobs/[id] returns isolation progress",
          "requirementId": "ISO-009",
          "description": "Verify job endpoint returns current isolation status",
          "setup": "Create job in ISOLATING state with 50% progress",
          "steps": [
            "Send GET request to /api/jobs/{jobId}",
            "Verify response status is 200",
            "Verify response.status is 'ISOLATING'",
            "Verify response.progress is 50",
            "Verify response.isolated_piano_path is null"
          ],
          "expectedResult": "Response includes current isolation progress",
          "mocks": []
        },
        {
          "id": "ISO-IT-002",
          "name": "GET /api/jobs/[id] returns completed isolation",
          "requirementId": "ISO-009",
          "description": "Verify job endpoint shows completed isolation with file path",
          "setup": "Create job in TRANSCRIBING state with isolated_piano_path set",
          "steps": [
            "Send GET request to /api/jobs/{jobId}",
            "Verify response status is 200",
            "Verify response.status is 'TRANSCRIBING'",
            "Verify response.isolated_piano_path contains valid path"
          ],
          "expectedResult": "Response includes isolated audio path after completion",
          "mocks": []
        },
        {
          "id": "ISO-IT-003",
          "name": "GET /api/jobs/[id] returns error details on failure",
          "requirementId": "ISO-007",
          "description": "Verify job endpoint shows error information for failed jobs",
          "setup": "Create job in FAILED state with error_code and error_message",
          "steps": [
            "Send GET request to /api/jobs/{jobId}",
            "Verify response status is 200",
            "Verify response.status is 'FAILED'",
            "Verify response.error_code is 'ISOLATION_API_ERROR'",
            "Verify response.error_message is user-friendly text"
          ],
          "expectedResult": "Response includes error details for failed jobs",
          "mocks": []
        },
        {
          "id": "ISO-IT-004",
          "name": "POST /api/jobs/[id]/retry restarts isolation",
          "requirementId": "ISO-007",
          "description": "Verify retry endpoint resets job to ISOLATING state",
          "setup": "Create job in FAILED state",
          "steps": [
            "Send POST request to /api/jobs/{jobId}/retry",
            "Verify response status is 200",
            "Verify response.status is 'ISOLATING'",
            "Verify job in database has status ISOLATING",
            "Verify job error_code and error_message are cleared"
          ],
          "expectedResult": "Job transitions back to ISOLATING for retry",
          "mocks": []
        },
        {
          "id": "ISO-IT-005",
          "name": "POST /api/jobs/[id]/retry rejects non-failed jobs",
          "requirementId": "ISO-007",
          "description": "Verify retry only works for failed jobs",
          "setup": "Create job in ISOLATING state",
          "steps": [
            "Send POST request to /api/jobs/{jobId}/retry",
            "Verify response status is 400",
            "Verify error message indicates job is not in failed state"
          ],
          "expectedResult": "Retry rejected for non-failed jobs",
          "mocks": []
        }
      ]
    },
    {
      "name": "Isolation UI Component Tests",
      "type": "component",
      "path": "src/components/__tests__/JobProgressStepper.test.tsx",
      "tests": [
        {
          "id": "ISO-CT-001",
          "name": "JobProgressStepper renders all 5 steps",
          "requirementId": "ISO-010",
          "description": "Verify stepper displays all processing steps",
          "setup": "Render JobProgressStepper with currentStep=2",
          "steps": [
            "Render component",
            "Verify 5 step labels are visible",
            "Verify labels are: UPLOAD, ISOLATE, TRANSCRIBE, NOTATE, DONE"
          ],
          "expectedResult": "All 5 steps are rendered with correct labels",
          "mocks": []
        },
        {
          "id": "ISO-CT-002",
          "name": "JobProgressStepper highlights current step in Swiss Red",
          "requirementId": "ISO-010",
          "description": "Verify active step is highlighted with accent color",
          "setup": "Render JobProgressStepper with currentStep=2 (ISOLATE)",
          "steps": [
            "Render component",
            "Find step 2 (ISOLATE) element",
            "Verify it has Swiss Red color (#FF3000)",
            "Verify other steps do not have red color"
          ],
          "expectedResult": "Current step is visually distinct with Swiss Red",
          "mocks": []
        },
        {
          "id": "ISO-CT-003",
          "name": "JobProgressStepper shows progress percentage",
          "requirementId": "ISO-010",
          "description": "Verify progress is displayed for current step",
          "setup": "Render JobProgressStepper with currentStep=2, progress=45",
          "steps": [
            "Render component",
            "Find progress display element",
            "Verify '45%' is visible",
            "Change progress to 80, verify '80%' is shown"
          ],
          "expectedResult": "Progress percentage updates with prop changes",
          "mocks": []
        },
        {
          "id": "ISO-CT-004",
          "name": "JobProgressStepper marks completed steps",
          "requirementId": "ISO-010",
          "description": "Verify steps before current are shown as completed",
          "setup": "Render JobProgressStepper with currentStep=3 (TRANSCRIBE)",
          "steps": [
            "Render component",
            "Find step 1 (UPLOAD) element",
            "Verify it shows completed state (filled indicator)",
            "Find step 2 (ISOLATE) element",
            "Verify it shows completed state"
          ],
          "expectedResult": "Past steps have filled/completed visual state",
          "mocks": []
        }
      ]
    },
    {
      "name": "Isolation E2E Flow Tests",
      "type": "e2e",
      "path": "e2e/isolation.spec.ts",
      "tests": [
        {
          "id": "ISO-E2E-001",
          "name": "Full isolation flow with real API",
          "requirementId": "ISO-002",
          "description": "End-to-end test of complete isolation process",
          "setup": "FAL_KEY must be set, test audio file available",
          "steps": [
            "Upload test audio file",
            "Verify job created in UPLOADED state",
            "Wait for status to change to ISOLATING",
            "Poll until status is TRANSCRIBING (or FAILED)",
            "Verify isolated_piano_path is set",
            "Verify file exists at isolated_piano_path",
            "Verify file is valid WAV audio"
          ],
          "expectedResult": "Complete isolation succeeds with valid output file",
          "mocks": [],
          "tags": ["slow", "requires-api-key"]
        },
        {
          "id": "ISO-E2E-002",
          "name": "Progress UI updates during isolation",
          "requirementId": "ISO-010",
          "description": "Verify frontend shows real-time progress",
          "setup": "FAL_KEY must be set, test audio file available",
          "steps": [
            "Upload test audio file",
            "Navigate to job progress page",
            "Verify stepper shows UPLOAD as completed",
            "Verify ISOLATE step becomes active",
            "Wait and verify progress percentage increases",
            "Verify ISOLATE step completes",
            "Verify TRANSCRIBE step becomes active"
          ],
          "expectedResult": "UI reflects real-time progress during isolation",
          "mocks": [],
          "tags": ["slow", "requires-api-key"]
        },
        {
          "id": "ISO-E2E-003",
          "name": "Error display and retry flow",
          "requirementId": "ISO-007",
          "description": "Verify error handling and retry UI",
          "setup": "Configure to trigger API error (e.g., invalid file)",
          "steps": [
            "Upload invalid audio file that will fail isolation",
            "Wait for job to reach FAILED state",
            "Verify error message is displayed",
            "Verify retry button is visible",
            "Click retry button",
            "Verify job status returns to ISOLATING"
          ],
          "expectedResult": "Error shown with working retry mechanism",
          "mocks": [],
          "tags": ["error-handling"]
        }
      ]
    },
    {
      "name": "Environment Configuration Tests",
      "type": "unit",
      "path": "src/lib/__tests__/fal-client.test.ts",
      "tests": [
        {
          "id": "ISO-ENV-001",
          "name": "fal client initializes with FAL_KEY",
          "requirementId": "ISO-011",
          "description": "Verify fal client uses environment variable",
          "setup": "Set FAL_KEY environment variable",
          "steps": [
            "Import fal client module",
            "Verify fal.config was called",
            "Verify credentials use FAL_KEY value"
          ],
          "expectedResult": "Client configured with correct API key",
          "mocks": []
        },
        {
          "id": "ISO-ENV-002",
          "name": "Application fails startup without FAL_KEY",
          "requirementId": "ISO-011",
          "description": "Verify clear error when API key missing",
          "setup": "Unset FAL_KEY environment variable",
          "steps": [
            "Attempt to start application",
            "Verify startup fails",
            "Verify error message mentions FAL_KEY"
          ],
          "expectedResult": "Clear error message about missing FAL_KEY",
          "mocks": []
        }
      ]
    }
  ],
  "testFixtures": [
    {
      "name": "mockFalSuccessResponse",
      "description": "Mock successful SAM Audio API response",
      "data": {
        "data": {
          "target": {
            "url": "https://fal.media/files/mock/isolated_piano.wav",
            "content_type": "audio/wav"
          },
          "residual": {
            "url": "https://fal.media/files/mock/residual.wav",
            "content_type": "audio/wav"
          },
          "duration": 30.5,
          "sample_rate": 48000
        },
        "requestId": "mock-request-id"
      }
    },
    {
      "name": "mockFalRateLimitError",
      "description": "Mock rate limit error from fal.ai",
      "data": {
        "error": {
          "status": 429,
          "message": "Rate limit exceeded"
        }
      }
    },
    {
      "name": "mockFalTimeoutError",
      "description": "Mock timeout error",
      "data": {
        "error": {
          "status": 504,
          "message": "Request timeout"
        }
      }
    },
    {
      "name": "mockFalInvalidAudioError",
      "description": "Mock invalid audio format error",
      "data": {
        "error": {
          "status": 400,
          "message": "Invalid audio format or corrupted file"
        }
      }
    },
    {
      "name": "testAudioFile",
      "description": "Short test audio file with piano",
      "path": "fixtures/test-piano-30s.mp3",
      "notes": "30 second MP3 with clear piano part for E2E testing"
    }
  ],
  "coverageRequirements": {
    "statements": 80,
    "branches": 75,
    "functions": 80,
    "lines": 80
  }
}
